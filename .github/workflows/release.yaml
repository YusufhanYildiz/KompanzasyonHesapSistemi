name: Release Application

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk

      - name: Extract Version
        id: vars
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Restore Dependencies
        run: dotnet restore

      - name: Build and Publish
        run: dotnet publish -c Release -o ./publish /p:Version=${{ steps.vars.outputs.tag }}

      - name: Create Velopack Package
        run: |
          vpk pack --packId "KompanzasyonHesap" --packVersion ${{ steps.vars.outputs.tag }} --packDir "./publish" --mainExe "KompanzasyonHesap.exe" --icon "Calculator_30001.ico" --outputDir "./Releases"

      - name: Upload to GitHub Release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Set Encoding to UTF-8 to handle Turkish characters correctly
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          # Ã–nce olasÄ± eski draft/release'i temizle
          gh release delete "v${{ steps.vars.outputs.tag }}" --yes || true
          
          # Release NotlarÄ±nÄ± OluÅŸtur (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in dosyaya yazÄ±yoruz)
          $releaseNotes = @"
          # v${{ steps.vars.outputs.tag }} - TaÅŸÄ±nabilirlik ve GeliÅŸmiÅŸ Yedekleme ğŸš€

          Bu sÃ¼rÃ¼m, uygulamanÄ±n taÅŸÄ±nabilirliÄŸini (portable) maksimize eder ve veri gÃ¼venliÄŸi iÃ§in yeni mekanizmalar sunar.

          ## âœ¨ Yenilikler
          
          ### ğŸ’ Tam TaÅŸÄ±nabilir Mod (Portable)
          - Uygulama artÄ±k tÃ¼m verilerini (Data, Backups, Logs) kendi Ã§alÄ±ÅŸtÄ±ÄŸÄ± klasÃ¶r iÃ§inde saklar.
          - `AppData` baÄŸÄ±mlÄ±lÄ±ÄŸÄ± tamamen kaldÄ±rÄ±lmÄ±ÅŸtÄ±r. USB bellekte sorunsuz Ã§alÄ±ÅŸÄ±r.

          ### ğŸ›¡ï¸ AkÄ±llÄ± Yedekleme Sistemi
          - **Otomatik Yedekleme:** Uygulama kapatÄ±lÄ±rken verileriniz artÄ±k otomatik olarak yedeklenir.
          - **BÃ¼tÃ¼nlÃ¼k DoÄŸrulamasÄ±:** Yedek dosyalarÄ± oluÅŸturulduktan sonra bozuk olup olmadÄ±klarÄ± otomatik kontrol edilir.
          
          ### âš™ï¸ Ayarlar ArayÃ¼zÃ¼
          - Ana menÃ¼ye yeni **Ayarlar** sekmesi eklendi.
          - "Ã‡Ä±kÄ±ÅŸta Otomatik Yedekle" Ã¶zelliÄŸi buradan aÃ§Ä±lÄ±p kapatÄ±labilir.

          ### ğŸ¨ GÃ¶rsel Ä°yileÅŸtirmeler
          - 1080p ve yÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼klÃ¼ ekranlar iÃ§in menÃ¼ hizalamalarÄ± dÃ¼zeltildi.
          - Buton yerleÅŸimleri optimize edildi.

          ## ğŸ“¦ Kurulum
          UygulamayÄ± indirmek iÃ§in aÅŸaÄŸÄ±daki **Assets** kÄ±smÄ±ndan **KompanzasyonHesap-win-Setup.exe** dosyasÄ±nÄ± kullanabilirsiniz.
          "@
          
          # DosyayÄ± UTF8 olarak kaydet (BOM olmadan da olur ama PowerShell default UTF8WithBOM yapabilir, gh action okurken sorun Ã§Ä±karmaz)
          $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding utf8

          # Velopack ile Release'i oluÅŸtur ve dosyalarÄ± yÃ¼kle
          # Velopack 'upload' komutu aslÄ±nda release'i de oluÅŸturur.
          vpk upload github --repoUrl "https://github.com/${{ github.repository }}" --token "$env:GITHUB_TOKEN" --publish --outputDir "./Releases" --tag "v${{ steps.vars.outputs.tag }}"
          
          # Release oluÅŸturulduktan sonra baÅŸlÄ±k ve aÃ§Ä±klamayÄ± gÃ¼ncelle
          # Not: Velopack varsayÄ±lan bir body ile oluÅŸturabilir, biz kendi notlarÄ±mÄ±zla eziyoruz.
          gh release edit "v${{ steps.vars.outputs.tag }}" --title "v${{ steps.vars.outputs.tag }} - Portable Mod & Otomatik Yedekleme" --notes-file "release_notes.md"
